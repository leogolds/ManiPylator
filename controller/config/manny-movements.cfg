[delayed_gcode my_delayed_gcode]
initial_duration: 1
gcode:
    GLOBAL_STATE
    GLOBAL_TARGET
    {action_call_remote_method("publish_mqtt_topic",
                            topic="status",
                            payload="waiting",
                            qos=0,
                            retain=True,
                            use_prefix=True)}

[gcode_macro GLOBAL_STATE]
variable_q1: 0
variable_q2: 0
variable_q3: 0
variable_q4: 0
variable_q5: 0
variable_q6: 0

gcode:
    M117 q1={q1} q2={q2} q3={q3} q4={q4} q5={q5} q6={q6}
    {action_call_remote_method("publish_mqtt_topic",
                                topic="state",
                                payload={"q1": q1, "q2": q2, "q3": q3, "q4": q4, "q5": q5, "q6": q6},
                                qos=0,
                                retain=True,
                                use_prefix=True)}

[gcode_macro GLOBAL_TARGET]
variable_q1: 0
variable_q2: 0
variable_q3: 0
variable_q4: 0
variable_q5: 0
variable_q6: 0

gcode:
    {action_call_remote_method("publish_mqtt_topic",
                                topic="target",
                                payload={"q1": q1, "q2": q2, "q3": q3, "q4": q4, "q5": q5, "q6": q6},
                                qos=0,
                                retain=True,
                                use_prefix=True)}

[gcode_macro SET_GLOBAL_STATE]
gcode:
    {% if params.Q1 is defined %}
        {% set param_q1 = params.Q1 | float %}
    {% else %}
        {% set param_q1 = printer["gcode_macro GLOBAL_STATE"].q1 %}
    {% endif %}

    {% if params.Q2 is defined %}
        {% set param_q2 = params.Q2 | float %}
    {% else %}
        {% set param_q2 = printer["gcode_macro GLOBAL_STATE"].q2 %}
    {% endif %}
    
     {% if params.Q3 is defined %}
        {% set param_q3 = params.Q3 | float %}
    {% else %}
        {% set param_q3 = printer["gcode_macro GLOBAL_STATE"].q3 %}
    {% endif %}
    
     {% if params.Q4 is defined %}
        {% set param_q4 = params.Q4 | float %}
    {% else %}
        {% set param_q4 = printer["gcode_macro GLOBAL_STATE"].q4 %}
    {% endif %}
    
     {% if params.Q5 is defined %}
        {% set param_q5 = params.Q5 | float %}
    {% else %}
        {% set param_q5 = printer["gcode_macro GLOBAL_STATE"].q5 %}
    {% endif %}
    
    {% if params.Q6 is defined %}
        {% set param_q6 = params.Q6 | float %}
    {% else %}
        {% set param_q6 = printer["gcode_macro GLOBAL_STATE"].q6 %}
    {% endif %}
    
    SET_GCODE_VARIABLE MACRO=GLOBAL_STATE VARIABLE=q1 VALUE={param_q1}
    SET_GCODE_VARIABLE MACRO=GLOBAL_STATE VARIABLE=q2 VALUE={param_q2}
    SET_GCODE_VARIABLE MACRO=GLOBAL_STATE VARIABLE=q3 VALUE={param_q3}
    SET_GCODE_VARIABLE MACRO=GLOBAL_STATE VARIABLE=q4 VALUE={param_q4}
    SET_GCODE_VARIABLE MACRO=GLOBAL_STATE VARIABLE=q5 VALUE={param_q5}
    SET_GCODE_VARIABLE MACRO=GLOBAL_STATE VARIABLE=q6 VALUE={param_q6}

    GLOBAL_STATE

[gcode_macro SET_GLOBAL_TARGET]
gcode:
    {% if params.Q1 is defined %}
        {% set param_q1 = params.Q1 | float %}
    {% else %}
        {% set param_q1 = printer["gcode_macro GLOBAL_STATE"].q1 %}
    {% endif %}

    {% if params.Q2 is defined %}
        {% set param_q2 = params.Q2 | float %}
    {% else %}
        {% set param_q2 = printer["gcode_macro GLOBAL_STATE"].q2 %}
    {% endif %}
    
     {% if params.Q3 is defined %}
        {% set param_q3 = params.Q3 | float %}
    {% else %}
        {% set param_q3 = printer["gcode_macro GLOBAL_STATE"].q3 %}
    {% endif %}
    
     {% if params.Q4 is defined %}
        {% set param_q4 = params.Q4 | float %}
    {% else %}
        {% set param_q4 = printer["gcode_macro GLOBAL_STATE"].q4 %}
    {% endif %}
    
     {% if params.Q5 is defined %}
        {% set param_q5 = params.Q5 | float %}
    {% else %}
        {% set param_q5 = printer["gcode_macro GLOBAL_STATE"].q5 %}
    {% endif %}
    
    {% if params.Q6 is defined %}
        {% set param_q6 = params.Q6 | float %}
    {% else %}
        {% set param_q6 = printer["gcode_macro GLOBAL_STATE"].q6 %}
    {% endif %}
    
    SET_GCODE_VARIABLE MACRO=GLOBAL_TARGET VARIABLE=q1 VALUE={param_q1}
    SET_GCODE_VARIABLE MACRO=GLOBAL_TARGET VARIABLE=q2 VALUE={param_q2}
    SET_GCODE_VARIABLE MACRO=GLOBAL_TARGET VARIABLE=q3 VALUE={param_q3}
    SET_GCODE_VARIABLE MACRO=GLOBAL_TARGET VARIABLE=q4 VALUE={param_q4}
    SET_GCODE_VARIABLE MACRO=GLOBAL_TARGET VARIABLE=q5 VALUE={param_q5}
    SET_GCODE_VARIABLE MACRO=GLOBAL_TARGET VARIABLE=q6 VALUE={param_q6}

    GLOBAL_TARGET

[gcode_macro ABSOLUTE_MOVEMENT_SIMULATED]
gcode:
    {% if params.Q1 is defined %}
        {% set param_q1 = params.Q1 | float %}
    {% else %}
        {% set param_q1 = printer["gcode_macro GLOBAL_STATE"].q1 %}
    {% endif %}

    {% if params.Q2 is defined %}
        {% set param_q2 = params.Q2 | float %}
    {% else %}
        {% set param_q2 = printer["gcode_macro GLOBAL_STATE"].q2 %}
    {% endif %}
    
     {% if params.Q3 is defined %}
        {% set param_q3 = params.Q3 | float %}
    {% else %}
        {% set param_q3 = printer["gcode_macro GLOBAL_STATE"].q3 %}
    {% endif %}
    
     {% if params.Q4 is defined %}
        {% set param_q4 = params.Q4 | float %}
    {% else %}
        {% set param_q4 = printer["gcode_macro GLOBAL_STATE"].q4 %}
    {% endif %}
    
     {% if params.Q5 is defined %}
        {% set param_q5 = params.Q5 | float %}
    {% else %}
        {% set param_q5 = printer["gcode_macro GLOBAL_STATE"].q5 %}
    {% endif %}
    
    {% if params.Q6 is defined %}
        {% set param_q6 = params.Q6 | float %}
    {% else %}
        {% set param_q6 = printer["gcode_macro GLOBAL_STATE"].q6 %}
    {% endif %}

    SET_GLOBAL_TARGET Q1={param_q1} Q2={param_q2} Q3={param_q3} Q4={param_q4} Q5={param_q5} Q6={param_q6}

    {action_call_remote_method("publish_mqtt_topic",
                            topic="status",
                            payload="moving",
                            qos=0,
                            retain=True,
                            use_prefix=True)}
    G4 P2000
    {action_call_remote_method("publish_mqtt_topic",
                            topic="status",
                            payload="waiting",
                            qos=0,
                            retain=True,
                            use_prefix=True)}

    SET_GLOBAL_STATE Q1={param_q1} Q2={param_q2} Q3={param_q3} Q4={param_q4} Q5={param_q5} Q6={param_q6}
 

[gcode_macro ABSOLUTE_MOVEMENT]
gcode:
    {% if params.Q1 is defined %}
        {% set param_q1 = params.Q1 | float %}
    {% else %}
        {% set param_q1 = printer["gcode_macro GLOBAL_STATE"].q1 %}
    {% endif %}

    {% if params.Q2 is defined %}
        {% set param_q2 = params.Q2 | float %}
    {% else %}
        {% set param_q2 = printer["gcode_macro GLOBAL_STATE"].q2 %}
    {% endif %}
    
     {% if params.Q3 is defined %}
        {% set param_q3 = params.Q3 | float %}
    {% else %}
        {% set param_q3 = printer["gcode_macro GLOBAL_STATE"].q3 %}
    {% endif %}
    
     {% if params.Q4 is defined %}
        {% set param_q4 = params.Q4 | float %}
    {% else %}
        {% set param_q4 = printer["gcode_macro GLOBAL_STATE"].q4 %}
    {% endif %}
    
     {% if params.Q5 is defined %}
        {% set param_q5 = params.Q5 | float %}
    {% else %}
        {% set param_q5 = printer["gcode_macro GLOBAL_STATE"].q5 %}
    {% endif %}
    
    {% if params.Q6 is defined %}
        {% set param_q6 = params.Q6 | float %}
    {% else %}
        {% set param_q6 = printer["gcode_macro GLOBAL_STATE"].q6 %}
    {% endif %}

    SET_GLOBAL_TARGET Q1={param_q1} Q2={param_q2} Q3={param_q3} Q4={param_q4} Q5={param_q5} Q6={param_q6}

    {action_call_remote_method("publish_mqtt_topic",
                            topic="status",
                            payload="moving",
                            qos=0,
                            retain=True,
                            use_prefix=True)}

    POSITION_TRUNC PITCH={param_q1} ROLL={param_q2} YAW={param_q3}
    POSITION_WRIST PITCH={param_q4} ROLL={param_q5} YAW={param_q6}    
    
    {action_call_remote_method("publish_mqtt_topic",
                            topic="status",
                            payload="waiting",
                            qos=0,
                            retain=True,
                            use_prefix=True)}

    SET_GLOBAL_STATE Q1={param_q1} Q2={param_q2} Q3={param_q3} Q4={param_q4} Q5={param_q5} Q6={param_q6}
    

    
    {action_call_remote_method("publish_mqtt_topic",
                            topic="status",
                            payload="waiting",
                            qos=0,
                            retain=True,
                            use_prefix=True)}



[gcode_macro POSITION_TRUNC_REL]
gcode:
    {% set pitch = params.PITCH|default(0)|float %}
    {% set roll = params.ROLL|default(0)|float %}
    {% set yaw = params.YAW|default(0)|float %}
    {% set pitch_speed = params.PITCH_SPD|default(0.2)|float %}
    {% set roll_speed = params.ROLL_SPD|default(0.2)|float %}
    {% set yaw_speed = params.YAW_SPD|default(0.2)|float %}

    G4 P10

    MANUAL_STEPPER STEPPER=turn_stpr ENABLE=1 
    MANUAL_STEPPER STEPPER=knee_a_stpr ENABLE=1 
    MANUAL_STEPPER STEPPER=knee_b_stpr ENABLE=1 

    {% if pitch != 0 %}
    MANUAL_STEPPER STEPPER=turn_stpr SET_POSITION=0 SPEED={pitch_speed} ACCEL=2 MOVE={pitch} SYNC=0
    {% endif %} 
 
    {% if roll != 0 %}
    MANUAL_STEPPER STEPPER=knee_a_stpr SET_POSITION=0 SPEED={roll_speed} ACCEL=2 MOVE={roll} SYNC=0
    {% endif %} 

    {% if yaw != 0 %}
    MANUAL_STEPPER STEPPER=knee_b_stpr SET_POSITION=0 SPEED={yaw_speed} ACCEL=2 MOVE={yaw} SYNC=0
    {% endif %} 

    MANUAL_STEPPER STEPPER=turn_stpr SYNC=1

    G4 P10

    MANUAL_STEPPER STEPPER=turn_stpr ENABLE=0
    MANUAL_STEPPER STEPPER=knee_a_stpr ENABLE=0
    MANUAL_STEPPER STEPPER=knee_b_stpr ENABLE=0

[gcode_macro POSITION_TRUNC]
gcode:
    {% set pitch = params.PITCH|default(0)|float %}
    {% set roll = params.ROLL|default(0)|float %}
    {% set yaw = params.YAW|default(0)|float %}
    {% set pitch_speed = params.PITCH_SPD|default(0.2)|float %}
    {% set roll_speed = params.ROLL_SPD|default(0.2)|float %}
    {% set yaw_speed = params.YAW_SPD|default(0.2)|float %}

    {% set current_q1 = printer["gcode_macro GLOBAL_STATE"].q1 %}
    {% set current_q2 = printer["gcode_macro GLOBAL_STATE"].q2 %}
    {% set current_q3 = printer["gcode_macro GLOBAL_STATE"].q3 %}
    {% set current_q4 = printer["gcode_macro GLOBAL_STATE"].q4 %}
    {% set current_q5 = printer["gcode_macro GLOBAL_STATE"].q5 %}
    {% set current_q6 = printer["gcode_macro GLOBAL_STATE"].q6 %}

    SET_GLOBAL_TARGET Q1={pitch} Q2={roll} Q3={yaw}

    G4 P10

    MANUAL_STEPPER STEPPER=turn_stpr ENABLE=1 
    MANUAL_STEPPER STEPPER=knee_a_stpr ENABLE=1 
    MANUAL_STEPPER STEPPER=knee_b_stpr ENABLE=1 

    MANUAL_STEPPER STEPPER=turn_stpr SET_POSITION={current_q1} SPEED={pitch_speed} ACCEL=2 MOVE={pitch} SYNC=0
    MANUAL_STEPPER STEPPER=knee_a_stpr SET_POSITION={current_q2} SPEED={roll_speed} ACCEL=2 MOVE={roll} SYNC=0
    MANUAL_STEPPER STEPPER=knee_b_stpr SET_POSITION={current_q3} SPEED={yaw_speed} ACCEL=2 MOVE={yaw} SYNC=0

    MANUAL_STEPPER STEPPER=turn_stpr SYNC=1

    G4 P10

    MANUAL_STEPPER STEPPER=turn_stpr ENABLE=0
    MANUAL_STEPPER STEPPER=knee_a_stpr ENABLE=0
    MANUAL_STEPPER STEPPER=knee_b_stpr ENABLE=0

    SET_GLOBAL_STATE Q1={pitch} Q2={roll} Q3={yaw}


[gcode_macro POSITION_WRIST_REL]
gcode:
    {% set pitch = params.PITCH|default(0)|float %}
    {% set roll = params.ROLL|default(0)|float %}
    {% set yaw = params.YAW|default(0)|float %}
    {% set pitch_speed = params.PITCH_SPD|default(0.4)|float %}
    {% set roll_speed = params.ROLL_SPD|default(0.4)|float %}
    {% set yaw_speed = params.YAW_SPD|default(0.4)|float %}

    G4 P10

    MANUAL_STEPPER STEPPER=pitch_stpr ENABLE=1 
    MANUAL_STEPPER STEPPER=roll_stpr ENABLE=1 
    MANUAL_STEPPER STEPPER=yaw_stpr ENABLE=1 

    {% if pitch != 0 %}
    MANUAL_STEPPER STEPPER=pitch_stpr SET_POSITION=0 SPEED={pitch_speed} ACCEL=2 MOVE={pitch} SYNC=0
    {% endif %} 
 
    {% if roll != 0 %}
    MANUAL_STEPPER STEPPER=roll_stpr SET_POSITION=0 SPEED={roll_speed} ACCEL=2 MOVE={roll} SYNC=0
    {% endif %} 

    {% if yaw != 0 %}
    MANUAL_STEPPER STEPPER=yaw_stpr SET_POSITION=0 SPEED={yaw_speed} ACCEL=2 MOVE={yaw} SYNC=0
    {% endif %} 

    MANUAL_STEPPER STEPPER=pitch_stpr SYNC=1

    G4 P10

    MANUAL_STEPPER STEPPER=pitch_stpr ENABLE=0
    MANUAL_STEPPER STEPPER=roll_stpr ENABLE=0
    MANUAL_STEPPER STEPPER=yaw_stpr ENABLE=0


[gcode_macro POSITION_WRIST]
gcode:
    {% set pitch = params.PITCH|default(0)|float %}
    {% set roll = params.ROLL|default(0)|float %}
    {% set yaw = params.YAW|default(0)|float %}
    {% set pitch_speed = params.PITCH_SPD|default(0.4)|float %}
    {% set roll_speed = params.ROLL_SPD|default(0.4)|float %}
    {% set yaw_speed = params.YAW_SPD|default(0.4)|float %}

    {% set current_q1 = printer["gcode_macro GLOBAL_STATE"].q1 %}
    {% set current_q2 = printer["gcode_macro GLOBAL_STATE"].q2 %}
    {% set current_q3 = printer["gcode_macro GLOBAL_STATE"].q3 %}
    {% set current_q4 = printer["gcode_macro GLOBAL_STATE"].q4 %}
    {% set current_q5 = printer["gcode_macro GLOBAL_STATE"].q5 %}
    {% set current_q6 = printer["gcode_macro GLOBAL_STATE"].q6 %}

    G4 P10

    MANUAL_STEPPER STEPPER=pitch_stpr ENABLE=1 
    MANUAL_STEPPER STEPPER=roll_stpr ENABLE=1 
    MANUAL_STEPPER STEPPER=yaw_stpr ENABLE=1 

    {% if pitch != 0 %}
    MANUAL_STEPPER STEPPER=pitch_stpr SET_POSITION={current_q4} SPEED={pitch_speed} ACCEL=2 MOVE={pitch} SYNC=0
    {% endif %} 
 
    {% if roll != 0 %}
    MANUAL_STEPPER STEPPER=roll_stpr SET_POSITION={current_q5} SPEED={roll_speed} ACCEL=2 MOVE={roll} SYNC=0
    {% endif %} 

    {% if yaw != 0 %}
    MANUAL_STEPPER STEPPER=yaw_stpr SET_POSITION={current_q6} SPEED={yaw_speed} ACCEL=2 MOVE={yaw} SYNC=0
    {% endif %} 

    MANUAL_STEPPER STEPPER=pitch_stpr SYNC=1

    G4 P10

    MANUAL_STEPPER STEPPER=pitch_stpr ENABLE=0
    MANUAL_STEPPER STEPPER=roll_stpr ENABLE=0
    MANUAL_STEPPER STEPPER=yaw_stpr ENABLE=0


[gcode_macro SEARCH_VARS]
gcode:
    {% set search = params.S|lower %}
    {% set ns = namespace() %}
    {% for item in printer  %}
        {% if ' ' in item %}
            {% set ns.path = ['printer', "['%s']" % (item), ''] %}
        {% else %}
            {% set ns.path = ['printer.', item, ''] %}   
        {% endif %} 

        {% if search in ns.path|lower %}
            { action_respond_info(ns.path|join) }
        {% endif %} 

        {% if printer[item].items() %}
            {% for childkey, child in printer[item].items() recursive %}
                {% set ns.path = ns.path[:loop.depth|int + 1] %}

                {% if ' ' in childkey %}
                    {% set null = ns.path.append("['%s']" % (childkey)) %}
                {% else %}
                    {% set null = ns.path.append(".%s" % (childkey)) %}
                {% endif %} 

                {% if child is mapping  %}
                    { loop(child.items()) }
                {% else %}
                    {% if search in ns.path|lower %}
                        { action_respond_info("%s : %s" % (ns.path|join, child)) }   
                    {% endif %} 
                {% endif %} 
                
            {% endfor %}
        {% endif %} 
    {% endfor %}